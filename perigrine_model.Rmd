---
title: "perigrine_distribution"
author: "Shale"
date: "1/5/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(librarian)

librarian::shelf(dismo, dplyr, DT, ggplot2, here, 
                 htmltools, leaflet, mapview, purrr, 
                 raster, readr, rgbif, rgdal, rJava, 
                 sdmpredictors, sf, spocc, tidyr)

select <- dplyr::select # overwrite raster::select
options(readr.show_col_types = FALSE)
```


```{r}
set.seed(15)

# directory to store data
dir_data <- here("data")
dir.create(dir_data, showWarnings = F)
```

## Load Data

```{r}
obs_csv <- file.path(dir_data, "obs.csv")
obs_geo <- file.path(dir_data, "obs.geojson")

if (!file.exists(obs_geo)){
  # get species occurrence data from GBIF with coordinates
  (res <- spocc::occ(
    query = 'Falco peregrinus', 
    from = 'gbif', has_coords = T,
    limit = 20000))
  
  # extract data frame from result
  df <- res$gbif$data[[1]] 
  readr::write_csv(df, obs_csv)
  
  # convert to points of observation from lon/lat columns in data frame
  obs <- df %>% 
    sf::st_as_sf(
      coords = c("longitude", "latitude"),
      crs = st_crs(4326)) %>% 
    select(prov, key) # save space (joinable from obs_csv)
  sf::write_sf(obs, obs_geo, delete_dsn=T)
}
obs <- sf::read_sf(obs_geo)
nrow(obs) # number of rows
```

```{r}
# show points on map
mapview::mapview(obs, map.types = "OpenTopoMap")
```

Though I set the limit to 20,000 ovservations, there are 1,738,469 occurrences of _Falco peregrinus_ on gbif.org as of 2022/01/05.

There are several sightings over the open ocean, which are probably erroneous. Some may not be (given that there are many sightings on nearby islands, and it is possible some birds may have been observed in flight between landmasses, particularly juveniles in search of new territory [`3399467453` in particular fits this possibility]) but to be safe I will remove all sightings not visibly over land. To remove these suspected false sightings:

```{r}
obs = obs %>% subset(!key %in% c(3407992796, 3399467453, 3415497266, 
                                 3394760531, 3332604472))

nrow(obs)
```

